name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
          
      - name: Install dependencies
        run: bun install
        
      - name: Type check
        run: bun run typecheck
          
      - name: Lint
        run: bun run lint
          
      - name: Format check
        run: bun run format:check
          
      - name: Test
        run: bun run test
          
      - name: Build
        run: bun run build
          
      - name: Test CLI with Node.js
        run: |
          TEST_DIR="test-cli-node-$$"
          mkdir -p "$TEST_DIR/src"
          echo 'export const test = "hello";' > "$TEST_DIR/src/test.ts"
          echo 'import { test } from "./test";' > "$TEST_DIR/src/main.ts"
          cd "$TEST_DIR"
          node ../bin/move-ts-file.js src/test.ts src/utils/test.ts
          # Verify the import was updated
          if ! grep -q 'from "./utils/test"' src/main.ts; then
            echo "CLI test failed - import not updated correctly"
            exit 1
          fi
          cd ..
          rm -rf "$TEST_DIR"
          
      - name: Test CLI with Bun
        run: |
          TEST_DIR="test-cli-bun-$$"
          mkdir -p "$TEST_DIR/src"
          echo 'export const test = "hello";' > "$TEST_DIR/src/test.ts"
          echo 'import { test } from "./test";' > "$TEST_DIR/src/main.ts"
          cd "$TEST_DIR"
          bun ../bin/move-ts-file.js src/test.ts src/lib/test.ts
          # Verify the import was updated
          if ! grep -q 'from "./lib/test"' src/main.ts; then
            echo "CLI test failed - import not updated correctly"
            exit 1
          fi
          cd ..
          rm -rf "$TEST_DIR"