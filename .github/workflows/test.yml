name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        bun-version: ['1.0', '1.1', 'latest']
        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
        
      - name: Setup Bun ${{ matrix.bun-version }}
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ matrix.bun-version }}
          
      - name: Install dependencies
        run: bun install --frozen-lockfile
        
      - name: Type check
        run: bun run typecheck
          
      - name: Lint
        run: bun run lint
          
      - name: Format check
        run: bun run format:check
          
      - name: Test
        run: bun run test
          
      - name: Build
        run: bun run build
          
      - name: Test CLI with Node.js
        run: |
          mkdir -p test-cli/src
          echo 'export const test = "hello";' > test-cli/src/test.ts
          echo 'import { test } from "./test";' > test-cli/src/main.ts
          cd test-cli
          node ../bin/move-ts-file.js src/test.ts src/utils/test.ts
          # Verify the import was updated
          if ! grep -q 'from "./utils/test"' src/main.ts; then
            echo "CLI test failed - import not updated correctly"
            exit 1
          fi
          cd ..
          rm -rf test-cli
          
      - name: Test CLI with Bun
        run: |
          mkdir -p test-cli/src
          echo 'export const test = "hello";' > test-cli/src/test.ts
          echo 'import { test } from "./test";' > test-cli/src/main.ts
          cd test-cli
          bun ../bin/move-ts-file.js src/test.ts src/lib/test.ts
          # Verify the import was updated
          if ! grep -q 'from "./lib/test"' src/main.ts; then
            echo "CLI test failed - import not updated correctly"
            exit 1
          fi
          cd ..
          rm -rf test-cli